function set_event_detection_map(){const e=firebase.firestore(),t=google.maps,o=new t.Map(dom_main_box_contents[0],MAP_CONFIG),n=[],s=new t.DirectionsService,i=SAVERS_CONFIG.length,r=[],l=[];for(let e=0;e<i;e++)r[e]=new t.Marker({map:o,title:SAVERS_CONFIG[e].title,position:SAVERS_CONFIG[e].position,icon:"https://maps.google.com/mapfiles/ms/micons/blue.png"});let a=void 0,c=void 0,p=void 0,g=void 0,m=void 0,_=!0;e.collection("Warning").onSnapshot(n=>{0==_&&e.collection("GPS").orderBy("time","desc").limit(1).get().then(n=>{n.forEach(n=>{a=n.data(),c=a.latitude,p=a.longtitude,g={lat:c,lng:p};const s=new t.LatLng((3*MAP_CONFIG.center.lat+c)/4,(3*MAP_CONFIG.center.lng+p)/4);o.setCenter(s),null!=m&&m.setMap(null),m=new t.Marker({map:o,title:"Warning",position:g,icon:"https://maps.google.com/mapfiles/ms/micons/orange.png"}),e.collection("Warning_GPS").doc(a.time.toString()).set(a)})}).catch(e=>{console.log(e)}),_=!1});let S=!0;e.collection("Danger").onSnapshot(r=>{if(0==S){m.setIcon("https://maps.google.com/mapfiles/ms/micons/red.png"),parse_path(l,s,c,p);for(let e=0;e<i;e++)n[e]=new t.DirectionsRenderer({map:o});Promise.all(l).then(e=>set_renderers(n,e)).then(e=>set_other_paths(s,n,c,p,e)).then(e=>set_shortest_paths(s,n,c,p,e)).then(e=>reset(a,m,e)).catch(e=>console.log(e)),e.collection("Danger_GPS").doc(a.time.toString()).set(a)}S=!1});let h=!0;e.collection("Cancel").onSnapshot(e=>{0==h&&reset(a,m,n),h=!1})}function parse_path(e,t,o,n){const s=SAVERS_CONFIG.length,i=google.maps;for(let r=0;r<s;r++)e[r]=new Promise((e,s)=>{t.route({origin:SAVERS_CONFIG[r].position,destination:{lat:o,lng:n},travelMode:"WALKING"},(t,o)=>{if(o==i.DirectionsStatus.OK){const n=get_distance(t,o);e(n)}else s(o)})})}function get_distance(e,t){let o=0;return e.routes[0].legs[0].steps.forEach(e=>{o+=e.distance.value}),o}function set_renderers(e,t){return new Promise(o=>{const n=SAVERS_CONFIG.length,s=t.indexOf(Math.min.apply(Math,t));for(let t=0;t<n;t++){const o=t===s?"Red":"Blue";e[t].setOptions({preserveViewport:!0,suppressMarkers:!0,polylineOptions:{strokeColor:o}})}o(s)})}function set_other_paths(e,t,o,n,s){return new Promise(i=>{const r=SAVERS_CONFIG.length,l=google.maps;for(let a=0;a<r;a++)a!=s&&e.route({origin:SAVERS_CONFIG[a].position,destination:{lat:o,lng:n},travelMode:"WALKING"},(e,o)=>{o==l.DirectionsStatus.OK?(t[a].setDirections(e),setTimeout(i,300,s)):reject(o)})})}function set_shortest_paths(e,t,o,n,s){return new Promise(i=>{SAVERS_CONFIG.length;const r=google.maps;e.route({origin:SAVERS_CONFIG[s].position,destination:{lat:o,lng:n},travelMode:"WALKING"},(e,o)=>{o==r.DirectionsStatus.OK?(t[s].setDirections(e),setTimeout(i,3e3,t)):console.log(o)})})}function reset(e,t,o){const n=firebase.firestore(),s=SAVERS_CONFIG.length;null!=t&&t.setMap(null);for(let e=0;e<s;e++)null!=o[e]&&o[e].setMap(null);n.collection("Finish").doc(e.time.toString()).set(e)}