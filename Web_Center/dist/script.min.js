const FIREBASE_CONFIG={apiKey:"AIzaSyDPqqCNoBOwPOrGtKK-6d8LM8fLwrfSheg",authDomain:"fall-detection-misakisuna.firebaseapp.com",databaseURL:"https://fall-detection-misakisuna.firebaseio.com",projectId:"fall-detection-misakisuna",storageBucket:"fall-detection-misakisuna.appspot.com",messagingSenderId:"540848496258",appId:"1:540848496258:web:e4f5d989c596cee97c5e9b",measurementId:"G-DNMDMSHEQ1"},NAVBAR_OPTIONS_CONFIG=["navbar_event_detection","navbar_warning_statistics","navbar_danger_statistics"],SIDEBAR_OPTIONS_CONFIG=["sidebar_event_detection","sidebar_warning_statistics","sidebar_danger_statistics"],MAIN_BOX_CONTENTS_CONFIG=["map_event_detection","map_warning_statistics","map_danger_statistics"],MAP_CONFIG={zoom:16,center:{lat:24.79438,lng:120.99331},scaleControl:!0,scrollwheel:!1,streetViewControl:!0},SAVERS_CONFIG=[{title:"衛保組",position:{lat:24.79625,lng:120.99431}},{title:"駐警隊",position:{lat:24.79169,lng:120.99168}},{title:"軍訓室",position:{lat:24.7925,lng:120.99394}}];
let dom_sidebar_menu,dom_navbar_menu,dom_map_nthu,dom_navbar_options=[],dom_sidebar_options=[],dom_main_box_contents=[];function get_dom(){const e=MAIN_BOX_CONTENTS_CONFIG.length;dom_sidebar_menu=document.getElementById("sidebar_menu"),dom_navbar_menu=document.getElementById("navbar_menu"),dom_map_nthu=document.getElementById("map_nthu");for(let n=0;n<e;n++)dom_navbar_options[n]=document.getElementById(NAVBAR_OPTIONS_CONFIG[n]),dom_sidebar_options[n]=document.getElementById(SIDEBAR_OPTIONS_CONFIG[n]),dom_main_box_contents[n]=document.getElementById(MAIN_BOX_CONTENTS_CONFIG[n])}
firebase.initializeApp(FIREBASE_CONFIG),window.addEventListener("DOMContentLoaded",()=>{get_dom(),set_rwd(),set_maps(),window.addEventListener("resize",set_rwd,!1),dom_navbar_menu.addEventListener("click",select_option,!1),dom_sidebar_menu.addEventListener("click",select_option,!1)},!1);
function set_maps(){const t=google.maps,e=new t.Map(dom_map_nthu,MAP_CONFIG),s=SAVERS_CONFIG.length,n=[];for(let i=0;i<s;i++)n[i]=new t.Marker({map:e,title:SAVERS_CONFIG[i].title,position:SAVERS_CONFIG[i].position,icon:"https://maps.google.com/mapfiles/ms/micons/blue.png"});set_event_detection_map(),set_warning_statistics_map(),set_danger_statistics_map()}
function select_option(){const n=MAIN_BOX_CONTENTS_CONFIG.length,t=event.target.id;dom_map_nthu.style.display="none";for(let e=0;e<n;e++)SIDEBAR_OPTIONS_CONFIG[e]==t?dom_main_box_contents[e].style.display="flex":dom_main_box_contents[e].style.display="none"}
function set_rwd(){const _=MAIN_BOX_CONTENTS_CONFIG.length;if(document.body.clientWidth<1024){dom_sidebar_menu.style.display="none",dom_navbar_menu.style.display="flex";for(let d=0;d<_;d++)dom_navbar_options[d].id=SIDEBAR_OPTIONS_CONFIG[d],dom_sidebar_options[d].id=NAVBAR_OPTIONS_CONFIG[d]}else{dom_sidebar_menu.style.display="flex",dom_navbar_menu.style.display="none";for(let d=0;d<_;d++)dom_navbar_options[d].id=NAVBAR_OPTIONS_CONFIG[d],dom_sidebar_options[d].id=SIDEBAR_OPTIONS_CONFIG[d]}}
function set_danger_statistics_map(){const e=firebase.firestore(),t=google.maps,o=new t.Map(dom_main_box_contents[2],MAP_CONFIG),n=(new t.DirectionsRenderer({map:o}),SAVERS_CONFIG.length),i=[];for(let e=0;e<n;e++)i[e]=new t.Marker({map:o,title:SAVERS_CONFIG[e].title,position:SAVERS_CONFIG[e].position,icon:"https://maps.google.com/mapfiles/ms/micons/blue.png"});e.collection("Danger_GPS").onSnapshot(e=>{e.forEach(e=>{const n=e.data();LAT=n.latitude,LNG=n.longtitude,POS={lat:LAT,lng:LNG};new t.Marker({map:o,title:"Danger",position:POS,icon:"https://maps.google.com/mapfiles/ms/micons/red.png"})})})}
function set_event_detection_map(){const e=firebase.firestore(),t=google.maps,o=new t.Map(dom_main_box_contents[0],MAP_CONFIG),n=[],s=new t.DirectionsService,i=SAVERS_CONFIG.length,r=[],l=[];for(let e=0;e<i;e++)r[e]=new t.Marker({map:o,title:SAVERS_CONFIG[e].title,position:SAVERS_CONFIG[e].position,icon:"https://maps.google.com/mapfiles/ms/micons/blue.png"});let a=void 0,c=void 0,p=void 0,g=void 0,m=void 0,_=!0;e.collection("Warning").onSnapshot(n=>{0==_&&e.collection("GPS").orderBy("time","desc").limit(1).get().then(n=>{n.forEach(n=>{a=n.data(),c=a.latitude,p=a.longtitude,g={lat:c,lng:p};const s=new t.LatLng((3*MAP_CONFIG.center.lat+c)/4,(3*MAP_CONFIG.center.lng+p)/4);o.setCenter(s),null!=m&&m.setMap(null),m=new t.Marker({map:o,title:"Warning",position:g,icon:"https://maps.google.com/mapfiles/ms/micons/orange.png"}),e.collection("Warning_GPS").doc(a.time.toString()).set(a)})}).catch(e=>{console.log(e)}),_=!1});let S=!0;e.collection("Danger").onSnapshot(r=>{if(0==S){m.setIcon("https://maps.google.com/mapfiles/ms/micons/red.png"),parse_path(l,s,c,p);for(let e=0;e<i;e++)n[e]=new t.DirectionsRenderer({map:o});Promise.all(l).then(e=>set_renderers(n,e)).then(e=>set_other_paths(s,n,c,p,e)).then(e=>set_shortest_paths(s,n,c,p,e)).then(e=>reset(a,m,e)).catch(e=>console.log(e)),e.collection("Danger_GPS").doc(a.time.toString()).set(a)}S=!1});let h=!0;e.collection("Cancel").onSnapshot(e=>{0==h&&reset(a,m,n),h=!1})}function parse_path(e,t,o,n){const s=SAVERS_CONFIG.length,i=google.maps;for(let r=0;r<s;r++)e[r]=new Promise((e,s)=>{t.route({origin:SAVERS_CONFIG[r].position,destination:{lat:o,lng:n},travelMode:"WALKING"},(t,o)=>{if(o==i.DirectionsStatus.OK){const n=get_distance(t,o);e(n)}else s(o)})})}function get_distance(e,t){let o=0;return e.routes[0].legs[0].steps.forEach(e=>{o+=e.distance.value}),o}function set_renderers(e,t){return new Promise(o=>{const n=SAVERS_CONFIG.length,s=t.indexOf(Math.min.apply(Math,t));for(let t=0;t<n;t++){const o=t===s?"Red":"Blue";e[t].setOptions({preserveViewport:!0,suppressMarkers:!0,polylineOptions:{strokeColor:o}})}o(s)})}function set_other_paths(e,t,o,n,s){return new Promise(i=>{const r=SAVERS_CONFIG.length,l=google.maps;for(let a=0;a<r;a++)a!=s&&e.route({origin:SAVERS_CONFIG[a].position,destination:{lat:o,lng:n},travelMode:"WALKING"},(e,o)=>{o==l.DirectionsStatus.OK?(t[a].setDirections(e),setTimeout(i,300,s)):reject(o)})})}function set_shortest_paths(e,t,o,n,s){return new Promise(i=>{SAVERS_CONFIG.length;const r=google.maps;e.route({origin:SAVERS_CONFIG[s].position,destination:{lat:o,lng:n},travelMode:"WALKING"},(e,o)=>{o==r.DirectionsStatus.OK?(t[s].setDirections(e),setTimeout(i,3e3,t)):console.log(o)})})}function reset(e,t,o){const n=firebase.firestore(),s=SAVERS_CONFIG.length;null!=t&&t.setMap(null);for(let e=0;e<s;e++)null!=o[e]&&o[e].setMap(null);n.collection("Finish").doc(e.time.toString()).set(e)}
function set_warning_statistics_map(){const n=firebase.firestore(),o=google.maps,t=new o.Map(dom_main_box_contents[1],MAP_CONFIG),e=(new o.DirectionsRenderer({map:t}),SAVERS_CONFIG.length),i=[];for(let n=0;n<e;n++)i[n]=new o.Marker({map:t,title:SAVERS_CONFIG[n].title,position:SAVERS_CONFIG[n].position,icon:"https://maps.google.com/mapfiles/ms/micons/blue.png"});n.collection("Warning_GPS").onSnapshot(n=>{n.forEach(n=>{const e=n.data();LAT=e.latitude,LNG=e.longtitude,POS={lat:LAT,lng:LNG};new o.Marker({map:t,title:"Warning",position:POS,icon:"https://maps.google.com/mapfiles/ms/micons/orange.png"})})})}